#include "message.h"
#include "mctp.h"
#include "main.h"
// u8 g_pkt5[] = {                         //som = 1;eom = 0;
//     0x00,0x00,0x00,0x00,
//     0x00,0x00,0x00,0x00,    //qw0

//     0x1c,0x00,0x00,0x00,    //qw1
//     0x00,0x00,0x00,0x00,

//     0x00,0x00,0x00,0x00,    //qw2
//     0x00,0x00,0x00,0x8B,

//     0x00,0x00,0x00,0x00,    //payload

//     0x01,0x01,0x01,0x01,    
//     0x01,0x01,0x01,0x01,
//     0x01,0x01,0x01,0x01,
//     0x01,0x01,0x01,0x01,
//     0x01,0x01,0x01,0x01,
//     0x01,0x01,0x01,0x01,
// };
u8 g_pkt0[] = {                         //som = 1;eom = 0;
    0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,    //qw0

    0x18,0x00,0x00,0x00,    //qw1
    0x00,0x00,0x00,0x00,

    0x00,0x00,0x00,0x8B,    //qw2
    0x00,0x00,0x00,0x00,

    0x00,0x00,0x00,0x00,    //payload

    0x01,0x01,0x01,0x01,    
    0x01,0x01,0x01,0x01,
    0x01,0x01,0x01,0x01,
    0x01,0x01,0x01,0x01,
    0x01,0x01,0x01,0x01,
};
u8 g_pkt1[] = {                         //som = 0;eom = 0;
    0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,    //qw0

    0x14,0x00,0x00,0x00,    //qw1
    0x00,0x00,0x00,0x00,

    0x00,0x00,0x00,0x1b,    //qw2
    0x00,0x00,0x00,0x00,

    //payload
    0x02,0x02,0x02,0x02,    
    0x02,0x02,0x02,0x02,
    0x02,0x02,0x02,0x02,
    0x02,0x02,0x02,0x02,
    0x02,0x02,0x02,0x02,
};
u8 g_pkt2[] = {                         //som = 0;eom = 0;
    0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,    //qw0

    0x14,0x00,0x00,0x00,    //qw1
    0x00,0x00,0x00,0x00,

    0x00,0x00,0x00,0x2b,    //qw2
    0x00,0x00,0x00,0x00,

    //payload
    0x03,0x03,0x03,0x03,    
    0x03,0x03,0x03,0x03,
    0x03,0x03,0x03,0x03,
    0x03,0x03,0x03,0x03,
    0x03,0x03,0x03,0x03,
};
u8 g_pkt3[] = {                         //som = 0;eom = 1;
    0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,    //qw0

    0x14,0x00,0x00,0x00,    //qw1
    0x00,0x00,0x00,0x00,

    0x00,0x00,0x00,0x7b,    //qw2
    0x00,0x00,0x00,0x00,

    //payload
    0x04,0x04,0x04,0x04,    
    0x04,0x04,0x04,0x04,  
    0x04,0x04,0x04,0x04,  
    0x04,0x04,0x04,0x04,  
    0x04,0x04,0x04,0x04,  
};
u8 g_pkt4[] = {                         //som = 1;eom = 1;
    0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,    //qw0

    0x18,0x00,0x00,0x00,    //qw1
    0x00,0x00,0x00,0x00,

    0x00,0x00,0x00,0xcb,    //qw2
    0x00,0x00,0x00,0x00,

    0x00,0x00,0x00,0x00,    //payload
    
    0x05,0x05,0x05,0x05,    
    0x05,0x05,0x05,0x05,   
    0x05,0x05,0x05,0x05,  
    0x05,0x05,0x05,0x05,  
    0x05,0x05,0x05,0x05, 
};

u8 g_pkt6[] = {                         //som = 0;eom = 0; msq_err
    0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,    //qw0

    0x14,0x00,0x00,0x00,    //qw1
    0x00,0x00,0x00,0x00,

    0x00,0x00,0x00,0x79,    //qw2
    0x00,0x00,0x00,0x00,

    //payload
    0x06,0x06,0x06,0x06,    
    0x06,0x06,0x06,0x06,  
    0x06,0x06,0x06,0x06,    
    0x06,0x06,0x06,0x06, 
    0x06,0x06,0x06,0x06,
};

u8 g_pkt7[] = {                         //som = 0;eom = 0; seq_err
    0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,    //qw0

    0x14,0x00,0x00,0x00,    //qw1
    0x00,0x00,0x00,0x00,

    0x00,0x00,0x00,0x2b,    //qw2
    0x00,0x00,0x00,0x00,

    //payload
    0x07,0x07,0x07,0x07,    
    0x07,0x07,0x07,0x07,
    0x07,0x07,0x07,0x07,    
    0x07,0x07,0x07,0x07,
    0x07,0x07,0x07,0x07,    
};
u8 g_pkt8[] = {                         //som = 0;eom = 0; blen_err
    0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,    //qw0

    0x00,0x00,0x00,0x00,    //qw1
    0x00,0x00,0x00,0x00,

    0x00,0x00,0x00,0x00,    //qw2
    0x00,0x00,0x00,0x2b,

    //payload
    0x08,0x08,0x08,0x08,    
    0x08,0x08,0x08,0x08, 
    0x08,0x08,0x08,0x08,    
    0x08,0x08,0x08,0x08, 
    0x08,0x08,0x08,0x08,    
};

u8 *g_mctp_pkt_s1e1_s0e1_suc[] = {
    g_pkt0,
    g_pkt1,
    g_pkt2,
    g_pkt3,
    g_pkt4,
};
u8 *g_mctp_pkt_mctp_err_1[] = {
    g_pkt0,
    g_pkt0,
    g_pkt1,
    g_pkt2,
    g_pkt3,                         //mctp_err_1
};
u8 *g_mctp_pkt_mctp_err_2[] = {
    g_pkt0,
    g_pkt1,
    g_pkt2,
    g_pkt4,                         //mctp_err_2
};
u8 *g_mctp_pkt_msg_err[] = {
    g_pkt0,
    g_pkt1,
    g_pkt2,
    g_pkt6,                         //msg_err
};
u8 *g_mctp_pkt_seq_err[] = {
    g_pkt0,
    g_pkt1,
    g_pkt2,
    g_pkt7,                         //seq_err
};
u8 *g_mctp_pkt_blen_err[] = {
    g_pkt4,
    g_pkt1,
    g_pkt2,                         
    g_pkt8,                         //blen_err
};
u8 *g_mctp_pkt_null_ptr_err[] = {   //null_ptr_err
    NULL,
    NULL,
    NULL,
    NULL,
};

static int pre_msg_tag = -1;
static u8 g_mctp_error = 0;
static u16 g_buf_len = 0;
static u8 gs_mctp_recv_buf[2048];

void clear_mctp_gobal_param(void)
{
    pre_msg_tag = -1;
    g_mctp_error = 0;
    g_buf_len = 0;
}

u16 get_mctp_buflen(void)
{
    return g_buf_len;
}

u8 get_mctp_error(void)
{
    return g_mctp_error;
}

int get_mctp_msg_tag(void)
{
    return pre_msg_tag;
}

PCIE_EXTCM_MSG *mctp_merge_pkt(PCIE_EXTCM_MSG *pkt, u8 *resv_buf)
{
    static int pre_pkt_seq = -1;

    if (!pkt) {
        g_mctp_error = 1;
        goto LL_NONE;
    }

    if (pkt->qw1.blen <= 0) {
        g_mctp_error = 2;
        goto LL_NONE;
    }

    mctp_hdr_t *ptr = (mctp_hdr_t *)&pkt->qw2.dw0;
    if (ptr->som == 1) {
        memcpy(resv_buf, pkt, (pkt->qw1.blen + UP_PROTOCOL_HDR_LEN)); //copy
        g_buf_len = (pkt->qw1.blen + UP_PROTOCOL_HDR_LEN);
        if (ptr->eom == 0) {
            if (pre_msg_tag != -1) {   //S1E0 S1E0 S1E0 S1E0 S0E0 S0E1 情况 多S1E0乱序
                g_mctp_error = 3;
            }
            pre_msg_tag = ptr->msg_tag;
            pre_pkt_seq = ptr->pkt_seq;
            goto LL_NONE;
        } else {
            if (pre_msg_tag != -1) {            //非S0E1 后接 S1E1 指向mctp_resv_buf首地址
                g_mctp_error = 4;
            }
            goto LL_SUC;
        }
    } else {
        pre_pkt_seq = (pre_pkt_seq + 1) & 0x3;
        if (pre_pkt_seq != ptr->pkt_seq) {  //pkt_seq 不匹配
            g_mctp_error = 5;
            goto LL_NONE;
        }
        if (pre_msg_tag != ptr->msg_tag) {      //msg_tag 不匹配
            g_mctp_error = 6;
            goto LL_NONE;
        }
        memcpy(resv_buf + g_buf_len, pkt->payload, (pkt->qw1.blen)); //copy
        g_buf_len += (pkt->qw1.blen);

        if (ptr->eom == 1) {   //som = 0;eom = 1;
            goto LL_SUC;
        }
        goto LL_NONE;
    }
LL_SUC:
    // merge done
    pre_pkt_seq = -1;
    return (PCIE_EXTCM_MSG *)resv_buf;
LL_NONE:
    // eom !=1
    return NULL;
}

void printf_mctp_merge_pkt(void)
{

    int i = 0;
    while (1) {
        i++;
        if (i == 5) {
            i = 0;
        }
        PCIE_EXTCM_MSG *buf = mctp_merge_pkt((PCIE_EXTCM_MSG *)g_mctp_pkt_s1e1_s0e1_suc[i], gs_mctp_recv_buf);
        if (buf != NULL) {
            for (int i = 0; i < get_mctp_buflen(); i++) {
                LOG("%d ", gs_mctp_recv_buf[i]);
            }
            LOG("%d %d\n", get_mctp_buflen(), get_mctp_error());
            clear_mctp_gobal_param();
        }
    }
    
}

