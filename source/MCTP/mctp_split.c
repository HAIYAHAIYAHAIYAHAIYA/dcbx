#include "message.h"
#include "mctp.h"
#include "main.h"

u8 g_pkt[] = {                         //som = 1;eom = 1;
    0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,    //qw0

    0xC3,0x00,0x00,0x00,    //qw1
    0x00,0xC5,0x00,0x00,

    0x00,0x00,0x00,0xc3,    //qw2
    0x00,0x00,0x00,0x00,

    0x00,0x00,0x00,0x00,    //payload 192 + 4 + 1

    0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,    
    0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01, 
    0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,    
    0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
    0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,    
    0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01, 
    0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,    
    0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
    0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,    
    0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01, 
    0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,    
    0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
};
u8 g_pkt_0[] = {                         //som = 1;eom = 1;
    0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,    //qw0

    0xC9,0x00,0x00,0x00,    //qw1
    0x00,0xC8,0x00,0x00,

    0x00,0x00,0x00,0xc3,    //qw2
    0x00,0x00,0x00,0x00,

    0x00,0x00,0x00,0x00,    //payload 192 + 4 + 1

    0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,    
    0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01, 
    0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,    
    0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
    0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,    
    0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01, 
    0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,    
    0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
    0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,    
    0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01, 
    0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,    
    0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
};
u8 g_pkt_1[] = {                         //som = 1;eom = 1;
    0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,    //qw0

    0x68,0x00,0x00,0x00,    //qw1
    0x00,0x68,0x00,0x00,

    0x00,0x00,0x00,0xc3,    //qw2
    0x00,0x00,0x00,0x00,

    0x00,0x00,0x00,0x00,    //payload 96 + 4 + 4

    0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,    
    0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01, 
    0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,    
    0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
    0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,    
    0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,
};
u8 g_pkt_unsplit[] = {                         //som = 1;eom = 1;
    0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,    //qw0

    0x5,0x00,0x00,0x00,    //qw1
    0x00,0x25,0x00,0x00,

    0x00,0x00,0x00,0xc3,    //qw2
    0x00,0x00,0x00,0x00,

    0x00,0x00,0x00,0x00,    //payload 32 + 4 + 1
    0x01,
};
u8 g_pkt_blen_err[] = {                         //som = 1;eom = 1; blen_err
    0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,    //qw0

    0x0,0x00,0x00,0x00,    //qw1
    0x00,0x00,0x00,0x00,

    0x00,0x00,0x00,0x00,    //qw2
    0x00,0x00,0x00,0xc3,
};

static void mctp_split_pkt_process(PCIE_EXTCM_MSG *pkt, u8 *sub_buf, u8 *copy_ptr)
{
    if (pkt->qw1.blen & 0x3) {
        u8 pad_len = (pkt->qw1.blen & 0x3) ? (4 - (pkt->qw1.blen & 0x3)) : 0;   //DW Pad caculation
        pkt->qw1.pcie_tag &= 0x0f;
        pkt->qw1.pcie_tag |= pad_len << 4;
        pkt->qw1.blen += pad_len;
    }
    memcpy(sub_buf, (u8 *)pkt, UP_PROTOCOL_HDR_LEN);
    memcpy(sub_buf + UP_PROTOCOL_HDR_LEN, copy_ptr, ((pkt->qw1.blen + 7) / QWORDSIZE) * QWORDSIZE);
}

void mctp_split_process(PCIE_EXTCM_MSG *pkt)
{
    if (!pkt) {
        return;
    }
    if (pkt->qw1.blen == 0) {
        return;
    }

    mctp_hdr_t *ptr = (mctp_hdr_t *)&pkt->qw2.dw0;
    u8 *copy_ptr = (u8 *)pkt->payload;
    u32 sub_buf[SPLIT_MIN_PKT_LEN / 4] = {0};                                                    
    u16 blen = pkt->qw1.blen;
    u8 count = 0;
                                                                                      
    count = (blen + 47) / COPY_LEN;                                          //分片包个数计算

    for (int i = 0; i < count; i++) {
        ptr->som = (i == 0);                                                                                        //set som
        ptr->eom = (i == count - 1);                                                                                //set eom
        ptr->pkt_seq = (i & 0x3);                                                                                   //seq 0~3循环
        pkt->qw1.blen = (i != count - 1) ? COPY_LEN : (blen - COPY_LEN * (count - 1));                              //blen 计算
        pkt->qw1.data_num = (pkt->qw1.blen + 7) / 8;                                                                //计算 QW aligned 个数 不够补0
        pkt->qw0.cnt = pkt->qw1.data_num + 2;                                                                       //cnt = data_num + 2
        mctp_split_pkt_process(pkt, (u8 *)sub_buf, copy_ptr);                                 
        copy_ptr += pkt->qw1.blen;                                                                                  //copy位置偏移

        int j = 0;                                                                                                  //printf                      
        for (j = 0; j < (pkt->qw0.cnt + 1) * 2; j++) {
            printf("%x ", sub_buf[j]);
        }
        printf("%d %d\n", j, ptr->pkt_seq);
    }
}
void printf_mctp_split_pkt(void)
{
    mctp_split_process((PCIE_EXTCM_MSG *)g_pkt);
}
